#!/usr/bin/env node
'use strict'

const program = require('commander');
const pkg = require('../package');
const budybody = require('../');
const log = require('modlog')('busy');

const PORT = require('..').DEFAULT_PORT;

program
    .version(pkg.version)
    .option('-b, --bridge [bindaddr]', 'run a bridge')
    .parse(process.argv);

if (program.bridge) {
    log.info('initializing bridge');

    var bindaddr = program.bridge;

    let cfg = {};

    /*
     * We just called the command with
     * the `--bridge` flag and no value.
     */
    if (bindaddr === true) {
        bindaddr = `127.0.0.1:${PORT}`;
    }

    if(bindaddr.indexOf(':') !== -1) {
        let _tmp = bindaddr.split(':');
        cfg = {
            host: _tmp[0],
            port: _tmp[1]
        };
    }

    if(bindaddr.indexOf('.sock') !== -1) {
        cfg = {path: bindaddr};
    }

    var b = budybody.createBridge(cfg, function (err) {
        if (err) {
            log.error(err.message || err);
            return process.exit(1);
        }
        log.info('bridge is now listening on "%s"', bindaddr);
    });

    process.once('SIGINT', function () {
        log.info('received SIGINT signal, closing bridge...');
        b.close();
        process.exit(0);
    });

} else {
    program.help();
}
